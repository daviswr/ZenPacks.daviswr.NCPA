name: ZenPacks.daviswr.NCPA

zProperties:
  DEFAULTS:
    category: Nagios
  zNcpaToken:
    type: string
  zNcpaPort:
    type: int
    default: 5693
  zNcpaFsBlockSize:
    type: int
    default: 4096
  zNcpaMonitorServices:
    type: boolean
    default: false
  zNcpaMonitorServiceNames:
    type: list
  zNcpaIgnoreServiceNames:
    type: string

device_classes:
  /Server/NCPA:
    remove: false

    zProperties:
      zCollectorPlugins:
        - daviswr.ncpa.DeviceMap
        - daviswr.ncpa.CpuMap
        - daviswr.ncpa.HardDiskMap
        - daviswr.ncpa.FileSystemMap
      zDeviceTemplates:
        - Device
      zNcpaToken: mytoken
      # Default /Server/Linux + ^nvme\d+n\d+$ + Physical and Drive for Windows
      zHardDiskMapMatch: "^[hs]d[a-z]\\d+$|c\\d+t\\d+d\\d+s\\d+$|^cciss\\/c\\dd\\dp\\d$|^dm\\-\\d$|^nvme\\d+n\\d+|Physical|Drive$"
      # Type strings don't match HOST-RESOURCES-MIB
      # https://github.com/NagiosEnterprises/ncpa/blob/master/agent/etc/ncpa.cfg
      # exclude_fs_types = aufs,autofs,binfmt_misc,cifs,cgroup,configfs,debugfs,devpts,devtmpfs,encryptfs,efivarfs,fuse,fusectl,hugetlbfs,mqueue,nfs,overlayfs,proc,pstore,rpc_pipefs,securityfs,selinuxfs,smb,sysfs,tmpfs,tracefs
      zFileSystemMapIgnoreTypes:
        - cdrom
      zSnmpMonitorIgnore: true

    templates:
      Device:
        targetPythonClass: Products.ZenModel.Device
        datasources:
          ncpa_response:
            type: HttpMonitor
            cycletime: 300
            eventClass: /Perf/NCPA
            component: NCPA
            hostname: ${dev/manageIp}
            ipAddress: ${dev/manageIp}
            port: ${dev/zNcpaPort}
            useSsl: true
            url: /api/system/agent_version?token=${dev/zNcpaToken}
            regex: "\"agent_version\":"
            onRedirect: critical
            timeout: 10
            datapoints:
              # Will be automatically added by HttpMonitor anyway
              time: GAUGE
              size: GAUGE

          Ping:
            type: PING
            # Broken on 4.2.5, only cycles every 300 seconds
            cycletime: 60
            # The PING datasource will add these itself anyway
            datapoints:
              rtt_avg: GAUGE
              rtt_min: GAUGE
              rtt_max: GAUGE
              rtt_losspct: GAUGE
              rtt_stddev: GAUGE

        graphs:
          DEFAULTS:
            miny: 0
          NCPA Response Time:
            units: milliseconds
            graphpoints:
              Time:
                dpName: ncpa_response_time
                rpn: "1000,*"
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 0
          Ping Time:
            units: milliseconds
            graphpoints:
              DEFAULTS:
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
              Average:
                dpName: Ping_rtt_avg
                lineType: AREA
                # To prevent washed-out color
                stacked: True
                colorindex: 0
              Maximum:
                dpName: Ping_rtt_max
                colorindex: 1
              Minimum:
                dpName: Ping_rtt_min
                colorindex: 2
          Packet Loss:
            units: percent
            graphpoints:
              Loss:
                dpName: Ping_rtt_losspct
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0

      FileSystem:
        targetPythonClass: Products.ZenModel.FileSystem
      OSProcess:
        targetPythonClass: Products.ZenModel.OSProcess
      CPU:
        targetPythonClass: Products.ZenModel.CPU
      HardDisk:
        targetPythonClass: Products.ZenModel.HardDisk
      ethernetCsmacd:
        targetPythonClass: Products.ZenModel.IpInterface
      WinService:
        targetPythonClass: Products.ZenModel.WinService


event_classes:
  /Perf/NCPA:
    remove: true
    description: Nagios Cross-Platform Agent performance

name: ZenPacks.daviswr.NCPA

class_relationships:
  - Products.ZenModel.Device.Device(ncpaServices) 1:MC Service(server)

classes:
  Service:
    # zenpacklib.Service makes fields all editable
    base: [zenpacklib.OSComponent]
    label: Service
    properties:
      DEFAULTS:
        grid_display: true
        details_display: true
      expected:
        label: Expected
        type: boolean
        enum: {true: "clear", false: "critical"}
        renderer: Zenoss.render.severity
        details_display: false
        order: 11
      expectedState:
        label: Expected Status
        type: int
        enum: {0: "running", 1: "stopped", 2: "unknown"}
        grid_display: false
        order: 6
      operState:
        label: Status
        type: int
        enum: {0: "running", 1: "stopped", 2: "unknown"}
        order: 10
      serviceName:
        label: Name
        type: string
        grid_display: false
        order: 5

zProperties:
  DEFAULTS:
    category: Nagios
  zNcpaToken:
    type: string
  zNcpaPort:
    type: int
    default: 5693
  zNcpaFsBlockSize:
    type: int
    default: 4096
  zNcpaServicesExpectedRunning:
    type: lines
    default:
      - ssh
      - sshd
      - TermService
  zNcpaServicesExpectedStopped:
    type: lines
  zNcpaServicesIgnored:
    type: lines
  # Warn & crit thresholds for:
  # cpu util
  # memory util
  # process count
  # filesystem util
  # network util

device_classes:
  /Server/NCPA:
    remove: false

    zProperties:
      zCollectorPlugins:
        - daviswr.ncpa.DeviceMap
        - daviswr.ncpa.CpuMap
        - daviswr.ncpa.HardDiskMap
        - daviswr.ncpa.FileSystemMap
        - daviswr.ncpa.InterfaceMap
        - daviswr.ncpa.ProcessMap
        - daviswr.ncpa.ServiceMap
      zDeviceTemplates:
        - Device
        - Ping
      # Type strings don't match HOST-RESOURCES-MIB
      # https://github.com/NagiosEnterprises/ncpa/blob/master/agent/etc/ncpa.cfg
      # exclude_fs_types = aufs,autofs,binfmt_misc,cifs,cgroup,configfs,debugfs,devpts,devtmpfs,encryptfs,efivarfs,fuse,fusectl,hugetlbfs,mqueue,nfs,overlayfs,proc,pstore,rpc_pipefs,securityfs,selinuxfs,smb,sysfs,tmpfs,tracefs
      zFileSystemMapIgnoreTypes:
        - cdrom
      # Default /Server/Linux + ^nvme\d+n\d+$
      zHardDiskMapMatch: "^[hs]d[a-z]\\d+$|c\\d+t\\d+d\\d+s\\d+$|^cciss\\/c\\dd\\dp\\d$|^dm\\-\\d$|^nvme\\d+n\\d+$"
      zIcon: /zport/dmd/img/icons/server.png
      zNcpaServicesExpectedRunning:
        - ncpa_listener
        - ncpa_passive
        # Nagios XI default Linux services
        - apache2
        - cron
        - crond
        - dovecot
        - httpd
        - mysql
        - mysqld
        - sendmail
        - ssh
        - sshd
        - syslog
        - rsyslog
      zNcpaServicesIgnored:
        # ZenPacks.zenoss.LinuxMonitor
        - addhostname
        - anacron
        - bluetooth
        - cpuspeed
        - ondemand
        - firstboot
        - irqbalance
        - isdn
        - lvm2-monitor
        - mcstrans
        - mdmonitor
        - portreserve
        - pppd-dns
        - rpcgssd
        - rsync
        - sudo
        - sysstat
      zNcpaToken: mytoken
      zSnmpMonitorIgnore: true

    templates:
      # /Server/NCPA/Device
      Device:
        targetPythonClass: Products.ZenModel.Device
        datasources:
          ncpa:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Device
            cycletime: 60
            datapoints:
              cpu_percent:
                rrdtype: GAUGE
                aliases:
                  # Compatibility with Zenoss CPU Utilization report
                  # https://monitoringartist.github.io/community.zenoss.org/docs/DOC-3025.html
                  cpu_pct: "0,+"
                  cpu__pct: "0,+"
              mem_rss: GAUGE
              mem_vms: GAUGE
              memory_available:
                rrdtype: GAUGE
                aliases:
                  memoryAvailable__bytes: "0,+"
              memory_free:
                rrdtype: GAUGE
                aliases:
                  freeMemory: "0,+"
                  memoryFree__bytes: "0,+"
              memory_percent:
                rrdtype: GAUGE
                aliases:
                  mem_pct: "0,+"
                  mem__pct: "0,+"
              memory_used:
                rrdtype: GAUGE
                aliases:
                  usedMemory: "0,+"
                  memoryUsed__bytes: "0,+"
              swap_free:
                rrdtype: GAUGE
                aliases:
                  freeSwap: "0,+"
                  swapFree__bytes: "0,+"
              swap_in: DERIVE_MIN_0
              swap_out: DERIVE_MIN_0
              swap_percent:
                rrdtype: GAUGE
                aliases:
                  swap_pct: "0,+"
                  swap__pct: "0,+"
              swap_used:
                rrdtype: GAUGE
                aliases:
                  usedSwap: "0,+"
                  swapUsed__bytes: "0,+"
              proc_cpu: GAUGE
              proc_mem: GAUGE
              processes: GAUGE
              users: GAUGE

          sysUpTime:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Device
            cycletime: 60
            datapoints:
              sysUpTime: GAUGE

          ncpa_response:
            type: HttpMonitor
            cycletime: 60
            eventClass: /Perf/NCPA
            component: NCPA
            hostname: ${dev/manageIp}
            ipAddress: ${dev/manageIp}
            port: ${dev/zNcpaPort}
            useSsl: true
            url: /api/system/agent_version?token=${dev/zNcpaToken}
            regex: "\"agent_version\":"
            onRedirect: critical
            timeout: 5
            datapoints:
              # Will be automatically added by HttpMonitor anyway
              time: GAUGE
              size: GAUGE

        graphs:
          DEFAULTS:
            miny: 0
          CPU Utilization:
            units: percentage
            graphpoints:
              Utilization:
                dpName: ncpa_proc_cpu
                lineType: AREA
                stacked: true
                colorindex: 0
              Average:
                dpName: ncpa_cpu_percent
                lineType: LINE
                lineWidth: 2
                colorindex: 0
          Memory and Swap Summary:
            units: percentage
            graphpoints:
              Memory:
                dpName: ncpa_memory_percent
                lineType: AREA
                stacked: true
                colorindex: 0
              Swap:
                dpName: ncpa_swap_percent
                lineType: LINE
                lineWidth: 2
                colorindex: 1
              Resident Set:
                dpName: ncpa_proc_mem
                lineType: LINE
                lineWidth: 2
                colorindex: 2
          Memory Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_memory_used
                colorindex: 0
              Buffers-Cache:
                dpName: ncpa_memory_free
                # Total - (Free + Used)
                rpn: "Used,+,-1,*,${here/hw/totalMemory},+"
                colorindex: 1
                legend: "Buffers/Cache"
              Free:
                dpName: ncpa_memory_free
                color: cccccc
          Memory Allocation:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Resident Set:
                dpName: ncpa_mem_rss
                colorindex: 0
              Available:
                dpName: ncpa_memory_available
                color: cccccc
              Virtual Memory:
                dpName: ncpa_mem_vms
                lineType: LINE
                lineWidth: 2
                stacked: false
                colorindex: 1
          Swap Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_swap_used
                colorindex: 0
              Free:
                dpName: ncpa_swap_free
                color: cccccc
          Swap Activity:
            units: bytes/sec
            graphpoints:
              In:
                dpName: ncpa_swap_in
                lineType: AREA
                stacked: true
                colorindex: 0
              Out:
                dpName: ncpa_swap_out
                lineType: LINE
                lineWidth: 2
                colorindex: 1
          Total Processes:
            units: processes
            graphpoints:
              Processes:
                dpName: ncpa_processes
                lineType: AREA
                stacked: true
                rpn: "CEIL,"
                format: "%5.0lf"
                colorindex: 0
          Logged-In Users:
            units: users
            graphpoints:
              Users:
                dpName: ncpa_users
                lineType: AREA
                stacked: true
                rpn: "CEIL,"
                format: "%5.0lf"
                colorindex: 0
          Agent Response Time:
            units: milliseconds
            graphpoints:
              Time:
                dpName: ncpa_response_time
                rpn: "1000,*"
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 0

      # /Server/NCPA/Ping
      Ping:
        targetPythonClass: Products.ZenModel.Device
        datasources:
          Ping:
            type: PING
            # Broken on 4.2.5, only cycles every 300 seconds
            # Products.ZenModel.PingDataSource has cycleTime (60)
            # but Products.ZenModel.RRDDataSource has cycletime
            cycleTime: 60
            # The PING datasource will add these itself anyway
            datapoints:
              rtt_avg: GAUGE
              rtt_min: GAUGE
              rtt_max: GAUGE
              rtt_losspct: GAUGE
              rtt_stddev: GAUGE
        graphs:
          DEFAULTS:
            miny: 0
          Ping Time:
            units: milliseconds
            graphpoints:
              DEFAULTS:
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
              Average:
                dpName: Ping_rtt_avg
                lineType: AREA
                # To prevent washed-out color
                stacked: true
                colorindex: 0
              Maximum:
                dpName: Ping_rtt_max
                colorindex: 1
              Minimum:
                dpName: Ping_rtt_min
                colorindex: 2
          Packet Loss:
            units: percent
            graphpoints:
              Loss:
                dpName: Ping_rtt_losspct
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0

      # /Server/NCPA/CPU
      CPU:
        targetPythonClass: Products.ZenModel.CPU
        datasources:
          cpu:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Processor
            eventClass: /Perf/CPU
            component: "${here/id}"
            cycletime: 60
            datapoints:
              percent: GAUGE
        graphs:
          Utilization:
            units: percentage
            miny: 0
            maxy: 100
            graphpoints:
              Utilization:
                dpName: cpu_percent
                lineType: AREA
                stacked: true
                colorindex: 0

      # /Server/NCPA/ethernetCsmacd
      ethernetCsmacd:
        targetPythonClass: Products.ZenModel.IpInterface

      # /Server/NCPA/FileSystem
      FileSystem:
        targetPythonClass: Products.ZenModel.FileSystem

      # /Server/NCPA/HardDisk
      HardDisk:
        targetPythonClass: Products.ZenModel.HardDisk
        datasources:
          disk-physical:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Storage
            eventClass: /Storage
            component: "${here/id}"
            cycletime: 60
            datapoints:
              read_bytes: DERIVE_MIN_0
              read_count: DERIVE_MIN_0
              write_bytes: DERIVE_MIN_0
              write_count: DERIVE_MIN_0
        graphs:
          DEFAULTS:
            miny: 0
          Activity:
            units: IOPS
            graphpoints:
              Write:
                dpName: disk-physical_write_count
                lineType: AREA
                stacked: true
                colorindex: 0
              Read:
                dpName: disk-physical_read_count
                lineType: LINE
                lineWidth: 2
                colorindex: 1
          Throughput:
            units: bytes/sec
            base: true
            graphpoints:
              Write:
                dpName: disk-physical_write_bytes
                lineType: AREA
                stacked: true
                colorindex: 0
              Read:
                dpName: disk-physical_read_bytes
                lineType: LINE
                lineWidth: 2
                colorindex: 1

      # /Server/NCPA/OSProcess
      OSProcess:
        targetPythonClass: Products.ZenModel.OSProcess

      # /Server/NCPA/Service
      Service:
        targetPythonClass: ZenPacks.daviswr.NCPA.NcpaService


  /Server/NCPA/Linux:
    # Inherits everything else from /Server/NCPA
    # since most NCPA-supported systems are Unix-like
    remove: false
    zProperties:
      zIcon: /zport/dmd/img/icons/server-linux.png

  /Server/NCPA/Windows:
    remove: false
    zProperties:
      zHardDiskMapMatch: "Physical|Drive"
      zIcon: /zport/dmd/img/icons/server-windows.png
      zNcpaServicesExpectedRunning:
        - ncpalistener
        - ncpapassive
        - TermService
        # Nagios XI default Windows services
        - MSSQLSERVER
        - MSSQL$SQLEXPRESS
        - WinDefend
        - MSSQLTELEMETRY
        - SQLTELEMETRY$SQLEXPRES
        - WAS
        - W3SVC
    templates:
      # /Server/NCPA/Windows/Device
      # Windows does not reported swapped_in or swapped_out metrics
      Device:
        targetPythonClass: Products.ZenModel.Device
        datasources:
          ncpa:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Device
            cycletime: 60
            datapoints:
              cpu_percent:
                rrdtype: GAUGE
                aliases:
                  # Compatibility with Zenoss CPU Utilization report
                  # https://monitoringartist.github.io/community.zenoss.org/docs/DOC-3025.html
                  cpu_pct: "0,+"
                  cpu__pct: "0,+"
              mem_rss: GAUGE
              mem_vms: GAUGE
              memory_available:
                rrdtype: GAUGE
                aliases:
                  memoryAvailable__bytes: "0,+"
              memory_free:
                rrdtype: GAUGE
                aliases:
                  freeMemory: "0,+"
                  memoryFree__bytes: "0,+"
              memory_percent:
                rrdtype: GAUGE
                aliases:
                  mem_pct: "0,+"
                  mem__pct: "0,+"
              memory_used:
                rrdtype: GAUGE
                aliases:
                  usedMemory: "0,+"
                  memoryUsed__bytes: "0,+"
              swap_free:
                rrdtype: GAUGE
                aliases:
                  freeSwap: "0,+"
                  swapFree__bytes: "0,+"
              swap_percent:
                rrdtype: GAUGE
                aliases:
                  swap_pct: "0,+"
                  swap__pct: "0,+"
              swap_used:
                rrdtype: GAUGE
                aliases:
                  usedSwap: "0,+"
                  swapUsed__bytes: "0,+"
              proc_cpu: GAUGE
              proc_mem: GAUGE
              processes: GAUGE
              users: GAUGE

          sysUpTime:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Device
            cycletime: 60
            datapoints:
              sysUpTime: GAUGE

          ncpa_response:
            type: HttpMonitor
            cycletime: 60
            eventClass: /Perf/NCPA
            component: NCPA
            hostname: ${dev/manageIp}
            ipAddress: ${dev/manageIp}
            port: ${dev/zNcpaPort}
            useSsl: true
            url: /api/system/agent_version?token=${dev/zNcpaToken}
            regex: "\"agent_version\":"
            onRedirect: critical
            timeout: 5
            datapoints:
              # Will be automatically added by HttpMonitor anyway
              time: GAUGE
              size: GAUGE

        graphs:
          DEFAULTS:
            miny: 0
          CPU Utilization:
            units: percentage
            graphpoints:
              Utilization:
                dpName: ncpa_proc_cpu
                lineType: AREA
                stacked: true
                colorindex: 0
              Average:
                dpName: ncpa_cpu_percent
                lineType: LINE
                lineWidth: 2
                colorindex: 0
          Memory and Swap Summary:
            units: percentage
            graphpoints:
              Memory:
                dpName: ncpa_memory_percent
                lineType: AREA
                stacked: true
                colorindex: 0
              Swap:
                dpName: ncpa_swap_percent
                lineType: LINE
                lineWidth: 2
                colorindex: 1
              Resident Set:
                dpName: ncpa_proc_mem
                lineType: LINE
                lineWidth: 2
                colorindex: 2
          Memory Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_memory_used
                colorindex: 0
              Buffers-Cache:
                dpName: ncpa_memory_free
                # Total - (Free + Used)
                rpn: "Used,+,-1,*,${here/hw/totalMemory},+"
                colorindex: 1
                legend: "Buffers/Cache"
              Free:
                dpName: ncpa_memory_free
                color: cccccc
          Memory Allocation:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Resident Set:
                dpName: ncpa_mem_rss
                colorindex: 0
              Available:
                dpName: ncpa_memory_available
                color: cccccc
              Virtual Memory:
                dpName: ncpa_mem_vms
                lineType: LINE
                lineWidth: 2
                stacked: false
                colorindex: 1
          Swap Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_swap_used
                colorindex: 0
              Free:
                dpName: ncpa_swap_free
                color: cccccc
          Total Processes:
            units: processes
            graphpoints:
              Processes:
                dpName: ncpa_processes
                lineType: AREA
                stacked: true
                rpn: "CEIL,"
                format: "%5.0lf"
                colorindex: 0
          Logged-In Users:
            units: users
            graphpoints:
              Users:
                dpName: ncpa_users
                lineType: AREA
                stacked: true
                rpn: "CEIL,"
                format: "%5.0lf"
                colorindex: 0
          Agent Response Time:
            units: milliseconds
            graphpoints:
              Time:
                dpName: ncpa_response_time
                rpn: "1000,*"
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 0


process_class_organizers:
  NCPA:
    remove: true
    process_classes:
      DEFAULTS:
        excludeRegex: "\\b(vim|tail|grep|tar|cat|bash)\\b"
        fail_severity: 4

      ncpa_listener:
        description: NCPA HTTP Listener Server
        includeRegex: ncpa_listener

      ncpa_passive:
        description: NCPA Passive Server
        includeRegex: ncpa_passive


event_classes:
  /Perf/NCPA:
    remove: true
    description: Nagios Cross-Platform Agent performance

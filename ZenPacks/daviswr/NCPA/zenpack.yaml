name: ZenPacks.daviswr.NCPA

class_relationships:
  - Products.ZenModel.Device.Device(ncpaServices) 1:MC Service(server)

classes:
  Service:
    # zenpacklib.Service makes fields all editable
    base: [zenpacklib.OSComponent]
    label: Service
    properties:
      DEFAULTS:
        grid_display: true
        details_display: true
      expectedState:
        label: Expected Status
        type: int
        enum: {0: "running", 1: "stopped", 2: "unknown"}
      operState:
        label: Status
        type: int
        enum: {0: "running", 1: "stopped", 2: "unknown"}
      expected:
        label: Expected
        type: int
        enum: {0: "clear", 1: "critical"}
        renderer: Zenoss.render.severity


zProperties:
  DEFAULTS:
    category: Nagios
  zNcpaToken:
    type: string
  zNcpaPort:
    type: int
    default: 5693
  zNcpaFsBlockSize:
    type: int
    default: 4096
  zNcpaServicesExpectedRunning:
    type: lines
    default:
      - ssh
      - sshd
      - TermService
  zNcpaServicesExpectedStopped:
    type: lines
  zNcpaServicesIgnored:
    type: lines


device_classes:
  /Server/NCPA:
    remove: false

    zProperties:
      zCollectorPlugins:
        - daviswr.ncpa.DeviceMap
        - daviswr.ncpa.CpuMap
        - daviswr.ncpa.HardDiskMap
        - daviswr.ncpa.FileSystemMap
        - daviswr.ncpa.InterfaceMap
        - daviswr.ncpa.ProcessMap
        - daviswr.ncpa.ServiceMap
      zDeviceTemplates:
        - Device
      # Type strings don't match HOST-RESOURCES-MIB
      # https://github.com/NagiosEnterprises/ncpa/blob/master/agent/etc/ncpa.cfg
      # exclude_fs_types = aufs,autofs,binfmt_misc,cifs,cgroup,configfs,debugfs,devpts,devtmpfs,encryptfs,efivarfs,fuse,fusectl,hugetlbfs,mqueue,nfs,overlayfs,proc,pstore,rpc_pipefs,securityfs,selinuxfs,smb,sysfs,tmpfs,tracefs
      zFileSystemMapIgnoreTypes:
        - cdrom
      # Default /Server/Linux + ^nvme\d+n\d+$
      zHardDiskMapMatch: "^[hs]d[a-z]\\d+$|c\\d+t\\d+d\\d+s\\d+$|^cciss\\/c\\dd\\dp\\d$|^dm\\-\\d$|^nvme\\d+n\\d+$"
      zIcon: /zport/dmd/img/icons/server.png
      zNcpaServicesExpectedRunning:
        # Nagios XI default Linux services
        - apache2
        - cron
        - crond
        - dovecot
        - httpd
        - mysql
        - mysqld
        - sendmail
        - ssh
        - sshd
        - syslog
        - rsyslog
      zNcpaServicesIgnored:
        # ZenPacks.zenoss.LinuxMonitor
        - addhostname
        - anacron
        - bluetooth
        - cpuspeed
        - ondemand
        - firstboot
        - irqbalance
        - isdn
        - lvm2-monitor
        - mcstrans
        - mdmonitor
        - portreserve
        - pppd-dns
        - rpcgssd
        - rsync
        - sudo
        - sysstat
      zNcpaToken: mytoken
      zSnmpMonitorIgnore: true


    templates:
      Device:
        targetPythonClass: Products.ZenModel.Device
        datasources:
          ncpa_response:
            type: HttpMonitor
            cycletime: 60
            eventClass: /Perf/NCPA
            component: NCPA
            hostname: ${dev/manageIp}
            ipAddress: ${dev/manageIp}
            port: ${dev/zNcpaPort}
            useSsl: true
            url: /api/system/agent_version?token=${dev/zNcpaToken}
            regex: "\"agent_version\":"
            onRedirect: critical
            timeout: 5
            datapoints:
              # Will be automatically added by HttpMonitor anyway
              time: GAUGE
              size: GAUGE

          Ping:
            type: PING
            # Broken on 4.2.5, only cycles every 300 seconds
            # Products.ZenModel.PingDataSource has cycleTime (60)
            # but Products.ZenModel.RRDDataSource has cycletime
            cycleTime: 60
            # The PING datasource will add these itself anyway
            datapoints:
              rtt_avg: GAUGE
              rtt_min: GAUGE
              rtt_max: GAUGE
              rtt_losspct: GAUGE
              rtt_stddev: GAUGE

        graphs:
          DEFAULTS:
            miny: 0
          NCPA Response Time:
            units: milliseconds
            graphpoints:
              Time:
                dpName: ncpa_response_time
                rpn: "1000,*"
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 0
          Ping Time:
            units: milliseconds
            graphpoints:
              DEFAULTS:
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
              Average:
                dpName: Ping_rtt_avg
                lineType: AREA
                # To prevent washed-out color
                stacked: True
                colorindex: 0
              Maximum:
                dpName: Ping_rtt_max
                colorindex: 1
              Minimum:
                dpName: Ping_rtt_min
                colorindex: 2
          Packet Loss:
            units: percent
            graphpoints:
              Loss:
                dpName: Ping_rtt_losspct
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0

      CPU:
        targetPythonClass: Products.ZenModel.CPU

      ethernetCsmacd:
        targetPythonClass: Products.ZenModel.IpInterface

      FileSystem:
        targetPythonClass: Products.ZenModel.FileSystem

      HardDisk:
        targetPythonClass: Products.ZenModel.HardDisk

      OSProcess:
        targetPythonClass: Products.ZenModel.OSProcess

      Service:
        targetPythonClass: ZenPacks.daviswr.NCPA.NcpaService


  /Server/NCPA/Linux:
    remove: false
    zProperties:
      zIcon: /zport/dmd/img/icons/server-linux.png

  /Server/NCPA/Windows:
    remove: false
    zProperties:
      zHardDiskMapMatch: "Physical|Drive"
      zIcon: /zport/dmd/img/icons/server-windows.png
      zNcpaServicesExpectedRunning:
        - TermService
        # Nagios XI default Windows services
        - MSSQLSERVER
        - MSSQL$SQLEXPRESS
        - WinDefend
        - MSSQLTELEMETRY
        - SQLTELEMETRY$SQLEXPRES
        - WAS
        - W3SVC


process_class_organizers:
  NCPA:
    remove: true
    process_classes:
      DEFAULTS:
        excludeRegex: "\\b(vim|tail|grep|tar|cat|bash)\\b"
        fail_severity: 4

      ncpa_listener:
        description: NCPA HTTP Listener Server
        includeRegex: ncpa_listener

      ncpa_passive:
        description: NCPA Passive Server
        includeRegex: ncpa_passive


event_classes:
  /Perf/NCPA:
    remove: true
    description: Nagios Cross-Platform Agent performance

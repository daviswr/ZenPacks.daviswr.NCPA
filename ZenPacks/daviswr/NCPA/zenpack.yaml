name: ZenPacks.daviswr.NCPA

class_relationships:
  - Products.ZenModel.Device.Device(ncpaServices) 1:MC Service(server)

classes:
  FileSystem:
    # RRDs are no longer under os/filesystems when using ZPL-based components
    base: [zenpacklib.FileSystem]
    label: File System
    plural_label: File Systems
    monitoring_templates:
      - FileSystem
    properties:
      DEFAULTS:
        type: int
        grid_display: false
        details_display: true
      warningThreshold:
        label: Warning Usage Percentage
        short_label: "Warning %"
        default: 70
        editable: true
        order: 20
      errorThreshold:
        label: Error Usage Percentage
        short_label: "Error %"
        default: 90
        editable: true
        order: 21

  Service:
    base: [zenpacklib.OSComponent]
    label: Service
    monitoring_templates:
      - OSService-NCPA
    properties:
      DEFAULTS:
        grid_display: false
        details_display: true
      expectedState:
        label: Expected Status
        type: int
        enum:
          0: "running"
          1: "stopped"
          2: "paused"
          3: "start_pending"
          4: "stop_pending"
          5: "pause_pending"
          6: "continue_pending"
          10: "unknown"
        order: 6
      operState:
        label: Current Status
        type: int
        datapoint: services_status
        enum:
          0: "running"
          1: "stopped"
          2: "paused"
          3: "start_pending"
          4: "stop_pending"
          5: "pause_pending"
          6: "continue_pending"
          10: "unknown"
        grid_display: true
        order: 10
      serviceName:
        label: Name
        type: string
        order: 5

zProperties:
  DEFAULTS:
    category: Nagios
    type: int
  zNcpaToken:
    type: string
  zNcpaPort:
    default: 5693
  zNcpaServicesExpectedRunning:
    type: lines
    default:
      - ssh
      - sshd
      - TermService
  zNcpaServicesExpectedStopped:
    type: lines
  zNcpaServicesIgnored:
    type: lines
  # The Nagios NCPA default thresholds seem unreasonably low
  # Nagios local & SNMP check defaults are better
  zNcpaThresholdCpuWarning:
    # NCPA check default is 20
    default: 80
  zNcpaThresholdCpuError:
    # NCPA check default is 40
    default: 90
  zNcpaThresholdUsersWarning:
    # NCPA check default is 2
    # SSH remote check default is 5
    default: 20
  zNcpaThresholdUsersError:
    # NCPA check default is 4
    # SSH remote check default is 10
    default: 50
  zNcpaThresholdMemoryWarning:
    # NCPA check default is 50
    # Local check default is 70
    default: 80
  zNcpaThresholdMemoryError:
    # NCPA & local check defaults are 80
    default: 90
  zNcpaThresholdSwapWarning:
    # NCPA & SNMP check defaults are 5
    # SSH remote check default is 70
    default: 50
  zNcpaThresholdSwapError:
    # NCPA & SNMP check defaults are 10
    # SSH remote check default is 90
    default: 70
  zNcpaThresholdProcWarning:
    # NCPA & ssh remote check defaults are 150
    default: 400
  zNcpaThresholdProcError:
    # SSH remote check default is 170
    # NCPA check default is 250
    default: 500


device_classes:
  /Server/NCPA:
    remove: false

    zProperties:
      zCollectorPlugins:
        - daviswr.ncpa.DeviceMap
        - daviswr.ncpa.CpuMap
        - daviswr.ncpa.HardDiskMap
        - daviswr.ncpa.FileSystemMap
        - daviswr.ncpa.InterfaceMap
        - daviswr.ncpa.ProcessMap
        - daviswr.ncpa.ServiceMap
      zDeviceTemplates:
        - Device
        - NCPA
        - Ping
      # Type strings don't match HOST-RESOURCES-MIB
      # https://github.com/NagiosEnterprises/ncpa/blob/master/agent/etc/ncpa.cfg#L42
      zFileSystemMapIgnoreTypes:
        - cdrom
      # Default /Server/Linux + ^nvme\d+n\d+$
      zHardDiskMapMatch: "^[hs]d[a-z]\\d+$|c\\d+t\\d+d\\d+s\\d+$|
^cciss\\/c\\dd\\dp\\d$|^dm\\-\\d$|^nvme\\d+n\\d+$"
      zIcon: /zport/dmd/img/icons/server.png
      zInterfaceMapIgnoreNames: "(ch.|docker|mgi|veth|vlan|virbr|^lo)"
      zNcpaServicesExpectedRunning:
        - ncpa_listener
        - ncpa_passive
        # Nagios XI default Linux services
        - apache2
        - cron
        - crond
        - dovecot
        - httpd
        - mysql
        - mysqld
        - sendmail
        - ssh
        - sshd
        - syslog
        - rsyslog
      zNcpaServicesIgnored:
        # ZenPacks.zenoss.LinuxMonitor
        - addhostname
        - anacron
        - bluetooth
        - cpuspeed
        - ondemand
        - firstboot
        - irqbalance
        - isdn
        - lvm2-monitor
        - mcstrans
        - mdmonitor
        - portreserve
        - pppd-dns
        - rpcgssd
        - rsync
        - sudo
        - sysstat
      zNcpaToken: mytoken
      zSnmpMonitorIgnore: true

    templates:
      # /Server/NCPA/Device
      Device:
        targetPythonClass: Products.ZenModel.Device
        description: Information about the system that NCPA is running on
        datasources:
          ncpa:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            cycletime: 60
            datapoints:
              cpu_idle:
                description: CPU time spent doing nothing
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ssCpuRawIdle_ssCpuRawIdle: "10,/"
              cpu_percent:
                description: Current system-wide CPU utilization as a percentage
                rrdtype: GAUGE
                aliases:
                  # Compatibility with Zenoss CPU Utilization report
                  # https://monitoringartist.github.io/community.zenoss.org/docs/DOC-3025.html
                  # https://help.zenoss.com/docs/appendixes/key-metrics
                  cpu_cpu: "0,+"
                  cpu_pct: "0,+"
                  cpu__pct: "0,+"
                  ssCpuIdle_ssCpuIdle: "-1,*"
              cpu_system:
                description: CPU time spent by processes executing in kernel mode
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ssCpuRawSystem_ssCpuRawSystem: "10,/"
              cpu_user:
                description: CPU time spent by normal processes executing in user mode
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ssCpuRawUser_ssCpuRawUser: "10,/"
              # api/processes/mem_rss sum
              mem_rss:
                description: Non-swapped physical memory processes have used
                rrdtype: GAUGE
              # api/processes/mem_vms sum
              mem_vms:
                description: Virtual memory used by processes
                rrdtype: GAUGE
              # api/memory/virtual
              memory_available:
                description: Memory that can be given instantly to processes
                rrdtype: GAUGE
                aliases:
                  mem_memAvailReal: "0,+"
                  memAvailReal_memAvailReal: "0,+"
                  memoryAvailable__bytes: "0,+"
              memory_free:
                description: Memory not being used at all that is readily available
                rrdtype: GAUGE
                aliases:
                  freeMemory: "0,+"
                  memoryFree__bytes: "0,+"
              memory_percent:
                description: Memory percentage used
                rrdtype: GAUGE
                aliases:
                  mem_mem: "0,+"
                  mem_pct: "0,+"
                  mem__pct: "0,+"
                  mem_percentMemUsed: "0,+"
                  mem_MemUsedPercent: "0,+"
              memory_used:
                description: Memory used, calculated differently depending on the platform
                rrdtype: GAUGE
                aliases:
                  mem_usage: "0,+"
                  memoryUsed__bytes: "0,+"
                  usedMemory: "0,+"
              # api/processes/cpu_percent sum
              proc_cpu:
                description: Process CPU utilization as a percentage
                rrdtype: GAUGE
              # api/processes/mem_percent sum
              proc_mem:
                description: Process memory utilization as a percentage
                rrdtype: GAUGE
              # api/processes count
              processes:
                description: Current running processes
                rrdtype: GAUGE
              # api/memory/swap
              swap_free:
                description: Free swap memory
                rrdtype: GAUGE
                aliases:
                  freeSwap: "0,+"
                  mem_memAvailSwap: "0,+"
                  mem_SwapFree: "0,+"
                  memAvailSwap_memAvailSwap: "0,+"
                  swapFree__bytes: "0,+"
              swap_in:
                description: Bytes the system has swapped in from disk
                rrdtype: DERIVE
                rrdmin: 0
              swap_out:
                description: Bytes the system has swapped out from disk
                rrdtype: DERIVE
                rrdmin: 0
              swap_percent:
                description: Swap percentage used
                rrdtype: GAUGE
                aliases:
                  swap_pct: "0,+"
                  swap__pct: "0,+"
              swap_used:
                description: Used swap memory
                rrdtype: GAUGE
                aliases:
                  swapUsed__bytes: "0,+"
                  usedSwap: "0,+"
              # api/user/count
              users:
                description: Users currently connected on the system
                rrdtype: GAUGE

          sysUpTime:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            cycletime: 60
            datapoints:
              # api/system/uptime * 100
              sysUpTime: GAUGE

        thresholds:
          CPU Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_cpu_percent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdCpuWarning
          CPU Usage Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_cpu_percent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdCpuError
          User Count Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_users
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdUsersWarning
          User Count Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_users
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdUsersError
          Memory Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_memory_percent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdMemoryWarning
          Memory Usage Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_memory_percent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdMemoryError
          Swap Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_swap_percent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdSwapWarning
          Swap Usage Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_swap_percent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdSwapError
          Process Count Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_processes
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdProcWarning
          Process Count Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_processes
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdProcError

        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          CPU Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Utilization:
                dpName: ncpa_cpu_percent
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0
          CPU Time:
            units: percent
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
                format: "%5.2lf"
                rpn: "100,*"
              cpu_system:
                dpName: ncpa_cpu_system
                lineType: DONTDRAW
                stacked: false
              cpu_user:
                dpName: ncpa_cpu_user
                lineType: DONTDRAW
                stacked: false
              Other:
                dpName: ncpa_cpu_idle
                rpn: "-100,*,100,+,cpu_system-rpn,-,cpu_user-rpn,-"
                legend: "IO, Interrupt, etc"
                color: 00cc00
              System:
                dpName: ncpa_cpu_system
                colorindex: 1
              User:
                dpName: ncpa_cpu_user
                colorindex: 2
          Memory and Swap Summary:
            units: percentage
            graphpoints:
              Memory:
                dpName: ncpa_memory_percent
                lineType: AREA
                stacked: true
                format: "%5.2lf"
                colorindex: 0
              Swap:
                dpName: ncpa_swap_percent
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 1
              Resident Set:
                dpName: ncpa_proc_mem
                lineType: LINE
                lineWidth: 2
                colorindex: 2
          Memory Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_memory_used
                colorindex: 0
              Buffers-Cache:
                dpName: ncpa_memory_free
                # Total - (Free + Used)
                rpn: "Used,+,-1,*,${here/hw/totalMemory},+"
                colorindex: 1
                legend: "Buffers/Cache"
              Free:
                dpName: ncpa_memory_free
                color: cccccc
          Memory Allocation:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              In Use:
                dpName: ncpa_memory_available
                # Total - Available
                rpn: "-1,*,${here/hw/totalMemory},+"
                colorindex: 0
              Available:
                dpName: ncpa_memory_available
                color: cccccc
          Swap Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_swap_used
                colorindex: 0
              Free:
                dpName: ncpa_swap_free
                color: cccccc
          Swap Activity:
            units: bytes/sec
            graphpoints:
              In:
                dpName: ncpa_swap_in
                lineType: AREA
                stacked: true
                colorindex: 0
              Out:
                dpName: ncpa_swap_out
                lineType: LINE
                lineWidth: 2
                colorindex: 1
          Total Processes:
            units: processes
            graphpoints:
              Processes:
                dpName: ncpa_processes
                lineType: AREA
                rpn: CEIL
                format: "%5.0lf"
                colorindex: 0
          Logged-In Users:
            units: users
            graphpoints:
              Users:
                dpName: ncpa_users
                lineType: LINE
                lineWidth: 2
                rpn: CEIL
                format: "%5.0lf"
                colorindex: 0

      # /Server/NCPA/NCPA
      NCPA:
        targetPythonClass: Products.ZenModel.Device
        description: Nagios Cross-Platform Agent response time
        datasources:
          ncpa_response:
            type: HttpMonitor
            cycletime: 60
            eventClass: /Status/Nagios
            hostname: ${dev/manageIp}
            ipAddress: ${dev/manageIp}
            port: ${dev/zNcpaPort}
            useSsl: true
            url: /api/system/agent_version?token=${dev/zNcpaToken}
            regex: '"agent_version":'
            onRedirect: critical
            timeout: 5
            datapoints:
              # Will be automatically added by HttpMonitor anyway
              time: GAUGE
              size: GAUGE
        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Agent Response Time:
            units: milliseconds
            graphpoints:
              Time:
                dpName: ncpa_response_time
                rpn: "1000,*"
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 0

      # /Server/NCPA/Ping
      Ping:
        targetPythonClass: Products.ZenModel.Device
        datasources:
          Ping:
            type: PING
            # Broken on 4.2.5, only cycles every 300 seconds
            # Products.ZenModel.PingDataSource has cycleTime (60)
            # but Products.ZenModel.RRDDataSource has cycletime
            cycleTime: 60
            # The PING datasource will add these itself anyway
            datapoints:
              rtt_avg: GAUGE
              rtt_min: GAUGE
              rtt_max: GAUGE
              rtt_losspct: GAUGE
              rtt_stddev: GAUGE

        thresholds:
          Ping Time Warning:
            type: MinMaxThreshold
            dsnames:
              - Ping_rtt_avg
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: 100
          Ping Time Error:
            type: MinMaxThreshold
            dsnames:
              - Ping_rtt_avg
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: 500
          Packet Loss Warning:
            type: MinMaxThreshold
            dsnames:
              - Ping_rtt_losspct
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: 20
          Packet Loss Error:
            type: MinMaxThreshold
            dsnames:
              - Ping_rtt_losspct
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: 60

        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Ping Time:
            units: milliseconds
            graphpoints:
              DEFAULTS:
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
              Average:
                dpName: Ping_rtt_avg
                lineType: AREA
                # To prevent washed-out color
                stacked: true
                colorindex: 0
              Maximum:
                dpName: Ping_rtt_max
                colorindex: 1
              Minimum:
                dpName: Ping_rtt_min
                colorindex: 2
          Packet Loss:
            units: percent
            graphpoints:
              Loss:
                dpName: Ping_rtt_losspct
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0

      # /Server/NCPA/CPU
      CPU:
        targetPythonClass: Products.ZenModel.CPU
        description: "Information on the currently used system-wide percentage,
 also the idle, user, and system time"
        datasources:
          cpu:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            eventClass: /Perf/CPU
            component: "${here/id}"
            cycletime: 60
            datapoints:
              idle: DERIVE_MIN_0
              percent: GAUGE
              system: DERIVE_MIN_0
              user: DERIVE_MIN_0
        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Utilization:
                dpName: cpu_percent
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0
          CPU Time:
            units: percent
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
                format: "%5.2lf"
                rpn: "100,*"
              system:
                dpName: cpu_system
                lineType: DONTDRAW
                stacked: false
              user:
                dpName: cpu_user
                lineType: DONTDRAW
                stacked: false
              Other:
                dpName: cpu_idle
                rpn: "-100,*,100,+,system-rpn,-,user-rpn,-"
                legend: "IO, Interrupt, etc"
                color: 00cc00
              System:
                dpName: cpu_system
                colorindex: 1
              User:
                dpName: cpu_user
                colorindex: 2

      # /Server/NCPA/ethernetCsmacd
      ethernetCsmacd:
        targetPythonClass: Products.ZenModel.IpInterface
        description: Counters for each of the available network interfaces
        datasources:
          # Emulate ZenCommand-based datasource name
          intf:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            eventClass: /Perf/Interface
            component: "${here/id}"
            cycletime: 60
            datapoints:
              # Emulate ZenCommand-based datapoint names
              ifInDiscards:
                description: Incoming packets which were dropped
                rrdtype: DERIVE
                rrdmin: 0
              # errin
              ifInErrors:
                description: Errors while receiving
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ifInErrors_ifInErrors: "0,+"
              # bytes_recv
              ifInOctets:
                description: Bytes received
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ifInOctets_ifInOctets: "0,+"
                  ethTraffic_Receive_Bytes: "0,+"
              # packets_recv
              ifInPackets:
                description: Packets received
                rrdtype: DERIVE
                rrdmin: 0
              # dropout
              ifOutDiscards:
                description: Outgoing packets which were dropped
                rrdtype: DERIVE
                rrdmin: 0
              # errout
              ifOutErrors:
                description: Errors while sending
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ifOutErrors_ifOutErrors: "0,+"
              # bytes_sent
              ifOutOctets:
                description: Bytes sent
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ifOutOctets_ifOutOctets: "0,+"
                  ethTraffic_Transmit_Bytes: "0,+"
              # packets_sent
              ifOutPackets:
                description: Packets sent
                rrdtype: DERIVE
                rrdmin: 0
              # NCPA does not report status similarly to IF-MIB::ifOperStatus
        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Throughput:
            units: bits/sec
            base: true
            graphpoints:
              Inbound:
                dpName: intf_ifInOctets
                lineType: AREA
                stacked: true
                rpn: 8,*
                colorindex: 0
              Outbound:
                dpName: intf_ifOutOctets
                lineType: LINE
                lineWidth: 1
                rpn: 8,*
                colorindex: 1
          Packets:
            units: packets/sec
            graphpoints:
              Inbound:
                dpName: intf_ifInPackets
                lineType: AREA
                stacked: true
                colorindex: 0
              Outbound:
                dpName: intf_ifOutPackets
                lineType: LINE
                lineWidth: 1
                colorindex: 1
          Errors:
            units: packets/sec
            graphpoints:
              Input:
                dpName: intf_ifInErrors
                lineType: AREA
                stacked: true
                colorindex: 0
              Output:
                dpName: intf_ifOutErrors
                lineType: LINE
                lineWidth: 1
                colorindex: 1
          Drops:
            units: packets/sec
            graphpoints:
              Input:
                dpName: intf_ifInDiscards
                lineType: AREA
                stacked: true
                colorindex: 0
              Output:
                dpName: intf_ifOutDiscards
                lineType: LINE
                lineWidth: 1
                colorindex: 1

      # /Server/NCPA/FileSystem
      FileSystem:
        targetPythonClass: Products.ZenModel.FileSystem
        description: Information on each mounted disk partition
        datasources:
          disk:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            eventClass: /Storage
            component: "${here/id}"
            cycletime: 60
            datapoints:
              # free / estimated block size
              availBlocks:
                rrdtype: GAUGE
                aliases:
                  availBlocks_availBlocks: "0,+"
              # inodes_free
              availInodes:
                rrdtype: GAUGE
                aliases:
                  idisk_availableInodes: "0,+"
              # used_percent
              dskPercent:
                rrdtype: GAUGE
                aliases:
                  disk_percentUsed: "0,+"
                  fs__pct: "0,+"
                  fs_used__pct: "0,+"
              free:
                description: Partition free space
                rrdtype: GAUGE
                aliases:
                  FreeMegabytes_FreeMegabytes: "1024,/,1024,/"
              # inodes_used_percent
              percentInodesUsed:
                rrdtype: GAUGE
                aliases:
                  idisk_percentInodesUsed: "0,+"
              # inodes
              totalInodes:
                rrdtype: GAUGE
                aliases:
                  idisk_totalInodes: "0,+"
              used:
                description: Partition used space
                rrdtype: GAUGE
                aliases:
                  fs_used__bytes: "0,+"
                  usedfilesystemspace__bytes: "0,+"
                  usedFilesystemSpace__bytes: "0,+"
              # used / estimated block size
              usedBlocks:
                rrdtype: GAUGE
                aliases:
                  usedBlocks_usedBlocks: "0,+"
              # inodes_used
              usedInodes:
                rrdtype: GAUGE
                aliases:
                  idisk_usedInodes: "0,+"

        thresholds:
          Disk Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - disk_dskPercent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.warningThreshold
          Disk Usage Error:
            type: MinMaxThreshold
            dsnames:
              - disk_dskPercent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.errorThreshold

        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Used:
                dpName: disk_dskPercent
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0
          Usage:
            units: bytes
            graphpoints:
              DEFAULTS:
                stacked: true
              Used:
                dpName: disk_used
                lineType: AREA
                colorindex: 0
              Free:
                dpName: disk_free
                lineType: AREA
                color: cccccc
          Inode Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Used:
                dpName: disk_percentInodesUsed
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0

      # /Server/NCPA/HardDisk
      HardDisk:
        targetPythonClass: Products.ZenModel.HardDisk
        description: Each physical drive's hardware stats
        datasources:
          diskstats:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            eventClass: /Storage
            component: "${here/id}"
            cycletime: 60
            datapoints:
              # read_bytes
              DiskReadBytesSec:
                description: Number of bytes read
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  hd_diskreadbytes__sec: "0,+"
              # write_bytes
              DiskWriteBytesSec:
                description: Number of bytes written
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  hd_diskwritebytes__sec: "0,+"
              # read_time
              msReading:
                description: Time spent reading from disk
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  disk_read_time__pct: "10,/"
              # write_time
              msWriting:
                description: Time spent writing to disk
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  disk_write_time__pct: "10,/"
              # read_count
              readsCompleted:
                description: Number of reads
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  disk_reads__persec: "0,+"
              # write_count
              writesCompleted:
                description: Number of writes
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  disk_writes__persec: "0,+"
        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Activity:
            units: IOPS
            graphpoints:
              Write:
                dpName: diskstats_writesCompleted
                lineType: AREA
                stacked: true
                colorindex: 0
              Read:
                dpName: diskstats_readsCompleted
                lineType: LINE
                lineWidth: 2
                colorindex: 1
          Throughput:
            units: bytes/sec
            base: true
            graphpoints:
              Write:
                dpName: diskstats_DiskWriteBytesSec
                lineType: AREA
                stacked: true
                colorindex: 0
              Read:
                dpName: diskstats_DiskReadBytesSec
                lineType: LINE
                lineWidth: 2
                colorindex: 1

      # /Server/NCPA/OSProcess
      OSProcess:
        targetPythonClass: Products.ZenModel.OSProcess
        description: Data about the process such as memory, CPU usage, and binary name
        datasources:
          processes:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Processes
            eventClass: /Status/OSProcess
            component: "${here/id}"
            cycletime: 60
            datapoints:
              count:
                description: Number of matching running processes
                rrdtype: GAUGE
                rrdmin: 0
                aliases:
                  count_count: "0,+"
                  process_count: "0,+"
                  ps_count: "0,+"
              cpu:
                description: Process CPU utilization as a percentage
                rrdtype: GAUGE
                rrdmin: 0
                aliases:
                  cpu_cpu: "0,+"
                  process_PercentProcessorTime: "0,+"
                  ps_cpu: "100,/"
                  ps_cpu__pct: "0,+"
              mem:
                description: Non-swapped physical memory a process has used
                rrdtype: GAUGE
                rrdmin: 0
                aliases:
                  mem_mem: "0,+"
                  process_WorkingSet: "0,+"
                  ps_mem: "0,+"
                  ps_mem__bytes: "0,+"
        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Process Count:
            units: processes
            graphpoints:
              Running:
                dpName: processes_count
                lineType: AREA
                rpn: CEIL
                format: "%5.0lf"
                colorindex: 0
          CPU Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Used:
                dpName: processes_cpu
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0
          Memory:
            units: bytes
            base: true
            graphpoints:
              Resident Set Size:
                dpName: processes_mem
                lineType: AREA
                colorindex: 0

      # /Server/NCPA/OSService-NCPA
      OSService-NCPA:
        targetPythonClass: ZenPacks.daviswr.NCPA.NcpaService
        description: Services' current state
        datasources:
          services:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            cycletime: 60
            datapoints:
              status: GAUGE
        thresholds:
          Service Status:
            type: MinMaxThreshold
            dsnames:
              - services_status
            severity: 4
            enabled: true
            eventClass: /Status/NCPA
            minval: here.expectedState
            maxval: here.expectedState

  /Server/NCPA/Linux:
    # Inherits everything else from /Server/NCPA
    # since most NCPA-supported systems are Unix-like
    remove: false
    zProperties:
      zIcon: /zport/dmd/img/icons/server-linux.png

  /Server/NCPA/Windows:
    remove: false
    zProperties:
      zHardDiskMapMatch: "Physical|Drive"
      zIcon: /zport/dmd/img/icons/server-windows.png
      zInterfaceMapIgnoreNames: "(Extension|Filter|ISATAP|Kernel Debug|
Miniport|RAS Async|Scheduler|Loopback)"
      zNcpaServicesExpectedRunning:
        - ncpalistener
        - ncpapassive
        - TermService
        # Nagios XI default Windows services
        - MSSQLSERVER
        - MSSQL$SQLEXPRESS
        - WinDefend
        - MSSQLTELEMETRY
        - SQLTELEMETRY$SQLEXPRESS
        - WAS
        - W3SVC
      # Logged-in user thresholds seem more important for RDP than SSH
      zNcpaThresholdUsersWarning: 2
      zNcpaThresholdUsersError: 4
    templates:
      # /Server/NCPA/Windows/Device
      # Windows does not reported swapped_in or swapped_out metrics
      Device:
        targetPythonClass: Products.ZenModel.Device
        description: Information about the system that NCPA is running on
        datasources:
          ncpa:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            cycletime: 60
            datapoints:
              cpu_idle:
                description: CPU time spent doing nothing
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ssCpuRawIdle_ssCpuRawIdle: "10,/"
              cpu_percent:
                description: Current system-wide CPU utilization as a percentage
                rrdtype: GAUGE
                aliases:
                  cpu_cpu: "0,+"
                  cpu_pct: "0,+"
                  cpu__pct: "0,+"
                  ssCpuIdle_ssCpuIdle: "-1,*"
              cpu_system:
                description: CPU time spent by processes executing in kernel mode
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ssCpuRawSystem_ssCpuRawSystem: "10,/"
              cpu_user:
                description: CPU time spent by normal processes executing in user mode
                rrdtype: DERIVE
                rrdmin: 0
                aliases:
                  ssCpuRawUser_ssCpuRawUser: "10,/"
              mem_rss:
                description: Non-swapped physical memory processes have used
                rrdtype: GAUGE
              mem_vms:
                description: Virtual memory used by processes
                rrdtype: GAUGE
              memory_available:
                description: Memory that can be given instantly to processes
                rrdtype: GAUGE
                aliases:
                  mem_memAvailReal: "0,+"
                  memAvailReal_memAvailReal: "0,+"
                  memoryAvailable__bytes: "0,+"
              memory_free:
                description: Memory not being used at all that is readily available
                rrdtype: GAUGE
                aliases:
                  freeMemory: "0,+"
                  memoryFree__bytes: "0,+"
              memory_percent:
                description: Memory percentage used
                rrdtype: GAUGE
                aliases:
                  mem_mem: "0,+"
                  mem_pct: "0,+"
                  mem__pct: "0,+"
                  mem_percentMemUsed: "0,+"
                  mem_MemUsedPercent: "0,+"
              memory_used:
                description: Memory used, calculated differently depending on the platform
                rrdtype: GAUGE
                aliases:
                  mem_usage: "0,+"
                  memoryUsed__bytes: "0,+"
                  usedMemory: "0,+"
              proc_cpu:
                description: Process CPU utilization as a percentage
                rrdtype: GAUGE
              proc_mem:
                description: Process memory utilization as a percentage
                rrdtype: GAUGE
              processes:
                description: Current running processes
                rrdtype: GAUGE
              swap_free:
                description: Free swap memory
                rrdtype: GAUGE
                aliases:
                  freeSwap: "0,+"
                  mem_memAvailSwap: "0,+"
                  mem_SwapFree: "0,+"
                  memAvailSwap_memAvailSwap: "0,+"
                  swapFree__bytes: "0,+"
              swap_in:
                description: Bytes the system has swapped in from disk
                rrdtype: DERIVE
                rrdmin: 0
              swap_out:
                description: Bytes the system has swapped out from disk
                rrdtype: DERIVE
                rrdmin: 0
              swap_percent:
                description: Swap percentage used
                rrdtype: GAUGE
                aliases:
                  swap_pct: "0,+"
                  swap__pct: "0,+"
              swap_used:
                description: Used swap memory
                rrdtype: GAUGE
                aliases:
                  swapUsed__bytes: "0,+"
                  usedSwap: "0,+"
              users:
                description: Users currently connected on the system
                rrdtype: GAUGE

          sysUpTime:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            cycletime: 60
            datapoints:
              sysUpTime: GAUGE

        thresholds:
          CPU Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_cpu_percent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdCpuWarning
          CPU Usage Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_cpu_percent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdCpuError
          User Count Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_users
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdUsersWarning
          User Count Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_users
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdUsersError
          Memory Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_memory_percent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdMemoryWarning
          Memory Usage Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_memory_percent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdMemoryError
          Swap Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - ncpa_swap_percent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdSwapWarning
          Swap Usage Error:
            type: MinMaxThreshold
            dsnames:
              - ncpa_swap_percent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.zNcpaThresholdSwapError

        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          CPU Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Utilization:
                dpName: ncpa_cpu_percent
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0
          CPU Time:
            units: percent
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
                format: "%5.2lf"
                rpn: "100,*"
              cpu_system:
                dpName: ncpa_cpu_system
                lineType: DONTDRAW
                stacked: false
              cpu_user:
                dpName: ncpa_cpu_user
                lineType: DONTDRAW
                stacked: false
              Other:
                dpName: ncpa_cpu_idle
                rpn: "-100,*,100,+,cpu_system-rpn,-,cpu_user-rpn,-"
                legend: "IO, Interrupt, etc"
                color: 00cc00
              System:
                dpName: ncpa_cpu_system
                colorindex: 1
              User:
                dpName: ncpa_cpu_user
                colorindex: 2
          Memory and Swap Summary:
            units: percentage
            graphpoints:
              Memory:
                dpName: ncpa_memory_percent
                lineType: AREA
                stacked: true
                format: "%5.2lf"
                colorindex: 0
              Swap:
                dpName: ncpa_swap_percent
                lineType: LINE
                lineWidth: 2
                format: "%5.2lf"
                colorindex: 1
          # Free = Available on Windows
          Memory Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_memory_used
                colorindex: 0
              Free:
                dpName: ncpa_memory_free
                color: cccccc
          Swap Utilization:
            units: bytes
            base: true
            graphpoints:
              DEFAULTS:
                lineType: AREA
                stacked: true
              Used:
                dpName: ncpa_swap_used
                colorindex: 0
              Free:
                dpName: ncpa_swap_free
                color: cccccc
          Total Processes:
            units: processes
            graphpoints:
              Processes:
                dpName: ncpa_processes
                lineType: AREA
                rpn: CEIL
                format: "%5.0lf"
                colorindex: 0
          Logged-In Users:
            units: users
            graphpoints:
              Users:
                dpName: ncpa_users
                lineType: LINE
                lineWidth: 2
                rpn: CEIL
                format: "%5.0lf"
                colorindex: 0

      # /Server/NCPA/Windows/FileSystem
      FileSystem:
        targetPythonClass: Products.ZenModel.FileSystem
        description: Information on each mounted disk partition
        datasources:
          disk:
            type: Python
            plugin_classname: ZenPacks.daviswr.NCPA.dsplugins.Agent
            eventClass: /Storage
            component: "${here/id}"
            cycletime: 60
            datapoints:
              # free / estimated block size
              availBlocks:
                rrdtype: GAUGE
                aliases:
                  availBlocks_availBlocks: "0,+"
              # used_percent
              dskPercent:
                rrdtype: GAUGE
                aliases:
                  disk_percentUsed: "0,+"
                  fs__pct: "0,+"
                  fs_used__pct: "0,+"
              free:
                description: Partition free space
                rrdtype: GAUGE
                aliases:
                  FreeMegabytes_FreeMegabytes: "1024,/,1024,/"
              used:
                description: Partition used space
                rrdtype: GAUGE
                aliases:
                  fs_used__bytes: "0,+"
                  usedfilesystemspace__bytes: "0,+"
                  usedFilesystemSpace__bytes: "0,+"
              # used / estimated block size
              usedBlocks:
                rrdtype: GAUGE
                aliases:
                  usedBlocks_usedBlocks: "0,+"

        thresholds:
          Disk Usage Warning:
            type: MinMaxThreshold
            dsnames:
              - disk_dskPercent
            severity: 3
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.warningThreshold
          Disk Usage Error:
            type: MinMaxThreshold
            dsnames:
              - disk_dskPercent
            severity: 4
            enabled: true
            eventClass: /Perf/NCPA
            maxval: here.errorThreshold

        graphs:
          DEFAULTS:
            height: 100
            width: 500
            miny: 0
          Utilization:
            units: percentage
            maxy: 100
            graphpoints:
              Used:
                dpName: disk_dskPercent
                lineType: AREA
                format: "%5.2lf"
                colorindex: 0
          Usage:
            units: bytes
            graphpoints:
              DEFAULTS:
                stacked: true
              Used:
                dpName: disk_used
                lineType: AREA
                colorindex: 0
              Free:
                dpName: disk_free
                lineType: AREA
                color: cccccc

process_class_organizers:
  NCPA:
    remove: true
    process_classes:
      DEFAULTS:
        excludeRegex: "\\b(vim|tail|grep|tar|cat|bash)\\b"
        fail_severity: 4

      ncpa_listener:
        description: NCPA HTTP Listener Server
        includeRegex: ncpa_listener

      ncpa_passive:
        description: NCPA Passive Server
        includeRegex: ncpa_passive


event_classes:
  /Perf/NCPA:
    remove: true
    description: Nagios Cross-Platform Agent performance

  /Status/NCPA:
    remove: true
    description: Nagios Cross-Platform Agent status
    transform: |-
      from ZenPacks.daviswr.NCPA.lib.ncpaUtil import service_states

      service_strings = dict(map(reversed, service_states.items()))

      if evt.eventKey.endswith('|Service Status'):
          status = service_strings.get(int(float(evt.current)), 'unknown')
          evt.summary = '{0} service is {1}'.format(evt.component, status)
